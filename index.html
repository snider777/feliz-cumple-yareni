let frases = ["Feliz cumple", "Yareni :D", "Que todos tus deseos...", "¡se hagan realidad!", "Te lo mereces :)"];
let lluvia = [];
let particulas = [];
let explosiones = [];
let cantidadParticulas = 100;

let clics = 0;
let modoDedicatoria = false;
let modoBorrado = false;
let modoExplosiones = false;
let modoMensajeFinal = false;
let modoOscurecer = false;

let dedicatoria = [
  "No sabía cómo empezar esto...",
  "Quería hacer algo especial...",
  "Tal vez esto sea raro...",
  "Pero viene con cariño :)"
];
let textoActual = "";
let indexFrase = 0;
let indexLetra = 0;
let tiempoInicioFrase = 0;
let tiempoDespuesDedicatoria = 0;

let mensajeFinal = "Ya no hay más sorpresas niña jajaja ... Que tengas un excelente cumple ... Mis mejores deseos :)";
let mensajeFinalActual = "";
let indexMensajeFinal = 0;
let tiempoInicioMensajeFinal = 0;

let opacidadPantalla = 0;

function setup() {
  createCanvas(windowWidth, windowHeight);
  textFont("Arial");
  textAlign(CENTER, CENTER);
  for (let i = 0; i < cantidadParticulas; i++) {
    particulas.push(new Particula());
  }
}

function draw() {
  background(0);

  // Partículas de fondo
  for (let p of particulas) {
    p.update();
    p.display();
  }

  // Lluvia de frases antes de la dedicatoria
  if (!modoDedicatoria) {
    for (let l of lluvia) {
      l.update();
      l.display();
    }
  }

  // Explosiones
  for (let e of explosiones) {
    e.update();
    e.display();
  }
  explosiones = explosiones.filter(e => !e.terminado());

  // Mostrar dedicatoria con efecto máquina de escribir
  if (modoDedicatoria && !modoBorrado && !modoMensajeFinal) {
    fill(255);
    textSize(28);
    text(textoActual, width / 2, height / 2);

    if (millis() - tiempoInicioFrase > 50 && indexFrase < dedicatoria.length) {
      if (indexLetra < dedicatoria[indexFrase].length) {
        textoActual += dedicatoria[indexFrase][indexLetra];
        indexLetra++;
        tiempoInicioFrase = millis();
      } else {
        if (millis() - tiempoInicioFrase > 1500) {
          indexFrase++;
          indexLetra = 0;
          if (indexFrase < dedicatoria.length) {
            textoActual += " "; // ← espacio entre frases
            tiempoInicioFrase = millis();
          } else {
            tiempoDespuesDedicatoria = millis();
            modoBorrado = true;
          }
        }
      }
    }
  }

  // Borrado letra por letra desde el inicio
  if (modoBorrado && !modoMensajeFinal) {
    fill(255);
    textSize(28);
    text(textoActual, width / 2, height / 2);

    if (millis() - tiempoDespuesDedicatoria > 15000) {
      if (frameCount % 3 === 0 && textoActual.length > 0) {
        textoActual = textoActual.substring(1);
      } else if (textoActual.length === 0) {
        modoExplosiones = true;
        tiempoInicioMensajeFinal = millis();
      }
    }
  }

  // Explosiones aleatorias y aumento de partículas
  if (modoExplosiones) {
    if (frameCount % 10 === 0 && random() < 0.4) {
      explosiones.push(new Explosion(random(width), random(height)));
    }

    if (particulas.length < 200) {
      particulas.push(new Particula());
    }

    if (millis() - tiempoInicioMensajeFinal > 15000) {
      modoExplosiones = false;
      modoMensajeFinal = true;
    }
  }

  // Escribir mensaje final letra por letra
  if (modoMensajeFinal) {
    fill(255);
    textSize(24);
    text(mensajeFinalActual, width / 2, height / 2 + 150);

    if (frameCount % 3 === 0 && indexMensajeFinal < mensajeFinal.length) {
      mensajeFinalActual += mensajeFinal[indexMensajeFinal];
      indexMensajeFinal++;
    } else if (indexMensajeFinal >= mensajeFinal.length) {
      modoOscurecer = true;
    }
  }

  // Oscurecer pantalla progresivamente
  if (modoOscurecer) {
    if (opacidadPantalla < 255) {
      opacidadPantalla += 1;
    }
    fill(0, opacidadPantalla);
    rect(0, 0, width, height);
  }
}

function mousePressed() {
  if (!modoDedicatoria) {
    clics++;
    lluvia.push(new Letra(random(frases)));
    explosiones.push(new Explosion(mouseX, mouseY));

    if (clics >= 40) {
      modoDedicatoria = true;
      textoActual = "";
      indexFrase = 0;
      indexLetra = 0;
      tiempoInicioFrase = millis();
      lluvia = [];
    }
  }
}

class Letra {
  constructor(txt) {
    this.txt = txt;
    this.x = random(width);
    this.y = random(-100, -20);
    this.speed = random(1, 3);
    this.color = color(180, 100, 255); // Violeta
  }

  update() {
    this.y += this.speed;
    if (this.y > height) {
      this.y = random(-100, -20);
      this.x = random(width);
    }
  }

  display() {
    fill(this.color);
    textSize(24);
    text(this.txt, this.x, this.y);
  }
}

class Particula {
  constructor() {
    this.x = random(width);
    this.y = random(height);
    this.size = random(1, 3);
    this.speed = random(0.3, 0.8);
  }

  update() {
    this.y += this.speed;
    if (this.y > height) {
      this.y = 0;
      this.x = random(width);
    }
  }

  display() {
    fill(150, 100);
    noStroke();
    ellipse(this.x, this.y, this.size);
  }
}

class Explosion {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.particles = [];
    for (let i = 0; i < 20; i++) {
      this.particles.push({
        x: this.x,
        y: this.y,
        vx: random(-3, 3),
        vy: random(-3, 3),
        alpha: 255
      });
    }
  }

  update() {
    for (let p of this.particles) {
      p.x += p.vx;
      p.y += p.vy;
      p.alpha -= 5;
    }
  }

  display() {
    noStroke();
    for (let p of this.particles) {
      fill(255, p.alpha);
      ellipse(p.x, p.y, 5);
    }
  }

  terminado() {
    return this.particles.every(p => p.alpha <= 0);
  }
}
